{% extends "base.html" %}
{% load static %}

{% block title %}{{ bus.bus_name }} - GoExplorer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/booking-styles.css' %}">
<style>
    .bus-header {
        background: linear-gradient(135deg, #FF6B35, #004E89);
        color: white;
        padding: 2rem 0;
    }

    .bus-info-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .route-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .route-timing {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 1rem 0;
    }

    .time-block {
        text-align: center;
    }

    .time-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: #004E89;
    }

    /* Improved Seat Layout Styles - 2x2 Grid */
    .seat-layout {
        background: #f8f9fa;
        padding: 2rem;
        border-radius: 8px;
        margin: 2rem 0;
    }

    .deck-section {
        margin-bottom: 3rem;
    }

    .deck-title {
        font-size: 1rem;
        font-weight: 700;
        color: #004E89;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #FF6B35;
        display: inline-block;
    }

    .driver-section {
        text-align: center;
        margin-bottom: 2rem;
        padding: 0.75rem;
        background: #e0e0e0;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #333;
    }

    .seat-grid {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: 280px;
        margin: 0 auto;
    }

    .seat-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
    }

    .seat-block {
        display: flex;
        gap: 0.5rem;
    }

    .aisle {
        width: 20px;
        height: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #999;
        font-weight: 600;
    }

    .seat {
        width: 45px;
        height: 45px;
        border: 2px solid #ddd;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
        position: relative;
        background: white;
        color: #333;
    }

    .seat:hover:not(.booked) {
        border-color: #FF6B35;
        background: #fff3e0;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
    }

    .seat.available {
        background: #e8f5e9;
        border-color: #4caf50;
        color: #2e7d32;
    }

    .seat.available:hover {
        background: #c8e6c9;
        border-color: #2e7d32;
    }

    /* Ladies seat - AVAILABLE but with visual indicator (NOT reserved/blocked) */
    .seat.ladies {
        background: #e8f5e9;  /* Same green as available - NOT pink! */
        border-color: #4caf50;
        color: #2e7d32;
        position: relative;
    }

    /* Lady icon indicator - shows this is a ladies-designated seat */
    .seat.ladies::before {
        content: '♀';
        position: absolute;
        font-size: 1rem;
        top: -6px;
        right: -6px;
        color: #e91e63;  /* Pink icon on green background */
        font-weight: bold;
        background: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }

    .seat.ladies:hover {
        background: #c8e6c9;  /* Same hover as available */
        border-color: #2e7d32;
    }

    .seat.booked {
        background: #ffebee;
        border-color: #f44336;
        color: #c62828;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .seat.booked:hover {
        background: #ffcdd2;
        border-color: #c62828;
        transform: none;
    }

    .seat.selected {
        background: #2196F3;
        border-color: #1565c0;
        color: white;
        box-shadow: 0 0 12px rgba(33, 150, 243, 0.4);
        font-weight: 700;
    }

    .seat.selected:hover {
        background: #1976d2;
        border-color: #1565c0;
        transform: scale(1.08);
    }

    .seat-legend {
        display: flex;
        gap: 2rem;
        margin: 2rem 0;
        flex-wrap: wrap;
        justify-content: center;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.95rem;
    }

    .legend-box {
        width: 35px;
        height: 35px;
        border: 2px solid;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .seat {
            width: 40px;
            height: 40px;
            font-size: 0.7rem;
        }

        .seat-legend {
            gap: 1.5rem;
            flex-direction: column;
            align-items: flex-start;
        }

        .seat-layout {
            padding: 1.5rem;
        }

        .driver-section {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 480px) {
        .seat {
            width: 36px;
            height: 36px;
            margin: 0.25rem;
            font-size: 0.65rem;
        }

        .seat-row {
            gap: 0.75rem;
        }

        .seat-layout {
            padding: 1rem;
        }

        .legend-item {
            font-size: 0.85rem;
        }

        .legend-box {
            width: 30px;
            height: 30px;
        }
    }

    .booking-widget {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 2rem;
        position: sticky;
        top: 100px;
    }

    .amenity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin: 2rem 0;
    }

    .amenity-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .amenity-item i {
        color: #FF6B35;
        font-size: 1.2rem;
    }

    .rating {
        color: #FFD700;
    }
</style>
{% endblock %}

{% block content %}
<!-- Bus Header -->
<div class="bus-header">
    <div class="container">
        <a href="/buses/" class="text-white-50 text-decoration-none">
            <i class="fas fa-chevron-left"></i> Back to Buses
        </a>
        <h1 class="mt-2 mb-0">{{ bus.bus_name }}</h1>
        <p class="mt-2 mb-0">{{ bus.bus_number }}</p>
    </div>
</div>

<div class="container my-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Operator Info -->
            <div class="bus-info-card">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="mb-3">{{ bus.operator.name }}</h4>
                        <p class="mb-2">
                            <i class="fas fa-star rating"></i> {{ bus.operator.rating }}/5 Rating
                        </p>
                        <p class="text-muted">{{ bus.operator.description }}</p>
                        <p class="mb-0">
                            <i class="fas fa-phone" style="color: #FF6B35;"></i>
                            <a href="tel:{{ bus.operator.contact_phone }}">{{ bus.operator.contact_phone }}</a>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <strong>{{ bus.get_bus_type_display }}</strong>
                        <p class="text-muted small">{{ bus.total_seats }} Total Seats</p>
                    </div>
                </div>
            </div>

            <!-- Amenities -->
            <div class="bus-info-card">
                <h5 class="mb-4">Amenities & Features</h5>
                <div class="amenity-grid">
                    {% if bus.has_ac %}<div class="amenity-item"><i class="fas fa-snowflake"></i> <span>Air Conditioning</span></div>{% endif %}
                    {% if bus.has_wifi %}<div class="amenity-item"><i class="fas fa-wifi"></i> <span>Free WiFi</span></div>{% endif %}
                    {% if bus.has_charging_point %}<div class="amenity-item"><i class="fas fa-plug"></i> <span>USB Charging</span></div>{% endif %}
                    {% if bus.has_blanket %}<div class="amenity-item"><i class="fas fa-blanket"></i> <span>Blanket</span></div>{% endif %}
                    {% if bus.has_water_bottle %}<div class="amenity-item"><i class="fas fa-droplet"></i> <span>Water Bottle</span></div>{% endif %}
                    {% if bus.has_tv %}<div class="amenity-item"><i class="fas fa-tv"></i> <span>In-bus Entertainment</span></div>{% endif %}
                </div>
            </div>

            <!-- Routes -->
            <div class="bus-info-card">
                <h5 class="mb-4">Available Routes</h5>
                {% for route in bus.routes.all %}
                    <div class="route-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>{{ route.source_city.name }} → {{ route.destination_city.name }}</h6>
                                <div class="route-timing">
                                    <div class="time-block">
                                        <div class="time-display">{{ route.departure_time|time:"H:i" }}</div>
                                        <small class="text-muted">Departure</small>
                                    </div>
                                    <div>
                                        <small class="text-muted">{{ route.duration_hours|floatformat:"1" }}h</small>
                                    </div>
                                    <div class="time-block">
                                        <div class="time-display">{{ route.arrival_time|time:"H:i" }}</div>
                                        <small class="text-muted">Arrival</small>
                                    </div>
                                </div>
                                <small class="text-muted">{{ route.distance_km|floatformat:"0" }} km</small>
                                <div class="mt-2 small text-muted">Boarding/Dropping shown in booking panel</div>
                            </div>
                            <div class="text-end">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #FF6B35;">
                                    ₹{{ route.base_fare|floatformat:"0" }}
                                </div>
                                <small class="text-muted d-block">per seat</small>
                                <a href="{% url 'buses:bus_detail' bus.id %}?route_id={{ route.id }}{% if travel_date_prefill %}&travel_date={{ travel_date_prefill }}{% endif %}" class="btn btn-sm btn-outline-primary mt-2">Select</a>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-muted">No routes available</p>
                {% endfor %}
            </div>

            <!-- Seat Layout -->
            {% if seats %}
            <div class="bus-info-card">
                <h5 class="mb-4">Seat Layout</h5>
                
                <!-- Improved 2x2 Grid Seat Layout Component -->
                <div class="seat-layout" id="seatLayout">
                    <div class="seat-legend">
                        <div class="legend-item">
                            <div class="legend-box" style="background: #e8f5e9; border-color: #4caf50;"><strong style="color: #4caf50;">G</strong></div>
                            <span>Available</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: #fce4ec; border-color: #e91e63;"><strong style="color: #e91e63;">♀</strong></div>
                            <span>Ladies Only</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: #ffebee; border-color: #f44336;"><strong style="color: #f44336;">✕</strong></div>
                            <span>Booked</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-box" style="background: #2196F3; border-color: #1565c0;"><strong style="color: white;">✓</strong></div>
                            <span>Selected</span>
                        </div>
                    </div>

                    <!-- Seats rendered by deck and row -->
                    {% regroup seats by deck as seats_by_deck %}
                    {% for deck_group in seats_by_deck %}
                    <div class="deck-section">
                        {% if has_multiple_decks %}
                        <div class="deck-title">
                            {% if deck_group.grouper > 1 %}Upper Deck{% else %}Lower Deck{% endif %}
                        </div>
                        {% endif %}

                        <div class="driver-section">
                            <i class="fas fa-user-tie"></i> DRIVER
                        </div>

                        <div class="seat-grid">
                            {% regroup deck_group.list by row as seats_by_row %}
                            {% for row_group in seats_by_row %}
                            <div class="seat-row">
                                <!-- Left Block (Seats A-B) -->
                                <div class="seat-block">
                                    {% for seat in row_group.list %}
                                        {% if forloop.counter <= 2 %}
                                        <input 
                                            type="checkbox" 
                                            class="seat-checkbox" 
                                            id="seat-{{ seat.id }}" 
                                            value="{{ seat.id }}" 
                                            data-gender="{{ seat.reserved_for }}" 
                                            data-number="{{ seat.seat_number }}" 
                                            style="display: none;">
                                        <label 
                                            for="seat-{{ seat.id }}" 
                                            class="seat {% if seat.is_booked %}booked{% elif seat.reserved_for == 'ladies' %}ladies{% else %}available{% endif %}" 
                                            title="Seat {{ seat.seat_number }} - {% if seat.reserved_for == 'ladies' %}Ladies Only{% elif seat.is_booked %}Booked{% else %}Available{% endif %}">
                                            {{ seat.seat_number }}
                                        </label>
                                        {% endif %}
                                    {% endfor %}
                                </div>

                                <!-- Aisle Separator -->
                                <div class="aisle">AISLE</div>

                                <!-- Right Block (Seats C-D) -->
                                <div class="seat-block">
                                    {% for seat in row_group.list %}
                                        {% if forloop.counter > 2 %}
                                        <input 
                                            type="checkbox" 
                                            class="seat-checkbox" 
                                            id="seat-{{ seat.id }}" 
                                            value="{{ seat.id }}" 
                                            data-gender="{{ seat.reserved_for }}" 
                                            data-number="{{ seat.seat_number }}" 
                                            style="display: none;">
                                        <label 
                                            for="seat-{{ seat.id }}" 
                                            class="seat {% if seat.is_booked %}booked{% elif seat.reserved_for == 'ladies' %}ladies{% else %}available{% endif %}" 
                                            title="Seat {{ seat.seat_number }} - {% if seat.reserved_for == 'ladies' %}Ladies Only{% elif seat.is_booked %}Booked{% else %}Available{% endif %}">
                                            {{ seat.seat_number }}
                                        </label>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <p class="text-muted small mt-3" style="text-align: center;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Seat Rules:</strong> 
                    Female passengers can book any available seat. Male passengers can only book general (green) seats.
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Booking Widget -->
        <div class="col-lg-4">
            <div class="booking-widget">
                <h4 class="mb-3">Book Your Seat</h4>
                
                {% if route %}
                    <form id="bookingForm" method="post" action="{% url 'buses:book_bus' bus.id %}">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="route" class="form-label">Route</label>
                            <select id="route_select" name="route_id" class="form-select" required>
                                {% for r in bus.routes.all %}
                                    <option value="{{ r.id }}" data-fare="{{ r.base_fare }}" data-departure="{{ r.departure_time|time:'H:i' }}" data-arrival="{{ r.arrival_time|time:'H:i' }}" {% if route.id == r.id %}selected{% endif %}>
                                        {{ r.source_city.name }} → {{ r.destination_city.name }} ({{ r.departure_time|time:'H:i' }} - {{ r.arrival_time|time:'H:i' }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label for="travel_date" class="form-label">Travel Date</label>
                            <input type="date" id="travel_date" name="travel_date" class="form-control" required value="{{ travel_date_prefill }}">
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Selected Seats</label>
                            <div id="selected_seats_display" class="form-control" style="background: #f8f9fa; border: 1px solid #ddd; padding: 0.5rem;">
                                <span class="text-muted">No seats selected</span>
                            </div>
                            <div id="seat_ids_container"></div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="passenger_name" class="form-label">Passenger Name</label>
                            <input type="text" id="passenger_name" name="passenger_name" class="form-control" required>
                        </div>

                        <div class="form-group mb-3">
                            <label for="passenger_age" class="form-label">Age</label>
                            <input type="number" id="passenger_age" name="passenger_age" class="form-control" min="1" required>
                        </div>

                        <div class="form-group mb-3">
                            <label for="passenger_gender" class="form-label">Gender</label>
                            <select id="passenger_gender" name="passenger_gender" class="form-select" required>
                                <option value="">Select</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>

                        <div id="ladies_seat_warning" class="alert alert-warning d-none" role="alert">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Seat Restriction:</strong> Male passengers cannot book ladies-only seats. Please select different seats.
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Boarding Point</label>
                            <select id="boarding_point" name="boarding_point" class="form-select" required>
                                {% for bp in boarding_points %}
                                    <option value="{{ bp.id }}" data-time="{{ bp.pickup_time|time:'H:i' }}">{{ bp.name }} ({{ bp.pickup_time|time:'H:i' }})</option>
                                {% empty %}
                                    <option value="">No boarding points configured</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Dropping Point</label>
                            <select id="dropping_point" name="dropping_point" class="form-select" required>
                                {% for dp in dropping_points %}
                                    <option value="{{ dp.id }}" data-time="{{ dp.drop_time|time:'H:i' }}">{{ dp.name }} ({{ dp.drop_time|time:'H:i' }})</option>
                                {% empty %}
                                    <option value="">No dropping points configured</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="alert alert-info small">
                            <div class="d-flex justify-content-between"><span>Base Fare (per seat)</span><span>₹<span id="baseFare">{{ route.base_fare|floatformat:"0" }}</span></span></div>
                            <div class="d-flex justify-content-between"><span>Convenience Fee ({{ conv_fee_pct }}%)</span><span>₹<span id="convFee">0</span></span></div>
                            <div class="d-flex justify-content-between"><span>GST ({{ gst_pct }}%)</span><span>₹<span id="gstAmount">0</span></span></div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between fw-bold"><span>Total</span><span>₹<span id="totalPrice">0</span></span></div>
                        </div>

                        {% if user.is_authenticated %}
                            <button type="submit" class="btn btn-primary w-100" id="bookNowBtn" disabled>
                                <i class="fas fa-check-circle"></i> Book Now
                            </button>
                        {% else %}
                            <a href="{% url 'users:login' %}?next={{ request.path|urlencode }}" class="btn btn-primary w-100">
                                <i class="fas fa-sign-in-alt"></i> Login to Book
                            </a>
                        {% endif %}
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ gst_pct|default:0|json_script:"gstData" }}
{{ conv_fee_pct|default:0|json_script:"feeData" }}
{{ booked_seat_ids|default:"[]"|json_script:"bookedSeatsData" }}
<script>
    // Define validateLadiesSeats FIRST, before DOM is even parsed
    function validateLadiesSeats() {
        const genderSelect = document.getElementById('passenger_gender');
        const seatCheckboxes = document.querySelectorAll('.seat-checkbox');
        const bookNowBtn = document.getElementById('bookNowBtn');
        const ladiesWarning = document.getElementById('ladies_seat_warning');
        
        if (!genderSelect) return;
        
        const selected = Array.from(seatCheckboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => ({
                id: checkbox.value,
                number: checkbox.dataset.number,
                reserved: checkbox.dataset.gender
            }));
        
        const gender = genderSelect.value;
        let hasInvalidSeat = false;
        let invalidSeats = [];
        
        selected.forEach(seat => {
            // Male can only book general seats
            if (gender === 'M' && seat.reserved === 'ladies') {
                hasInvalidSeat = true;
                invalidSeats.push(seat.number);
            }
            // Female can book any seat
            // Other genders can only book general seats
            if (gender === 'O' && seat.reserved === 'ladies') {
                hasInvalidSeat = true;
                invalidSeats.push(seat.number);
            }
        });

        if (ladiesWarning) {
            if (hasInvalidSeat) {
                ladiesWarning.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Seat Restriction:</strong> Seats ${invalidSeats.join(', ')} are reserved for female passengers only. Please select different seats.`;
                ladiesWarning.classList.remove('d-none');
                if (bookNowBtn) bookNowBtn.disabled = true;
            } else {
                ladiesWarning.classList.add('d-none');
                if (bookNowBtn && gender) {
                    bookNowBtn.disabled = selected.length === 0;
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const routeSelect = document.getElementById('route_select');
        const travelDate = document.getElementById('travel_date');
        const baseFareEl = document.getElementById('baseFare');
        const convFeeEl = document.getElementById('convFee');
        const gstEl = document.getElementById('gstAmount');
        const totalEl = document.getElementById('totalPrice');
        const bookNowBtn = document.getElementById('bookNowBtn');
        const genderSelect = document.getElementById('passenger_gender');
        const seatCheckboxes = document.querySelectorAll('.seat-checkbox');
        const selectedSeatsDisplay = document.getElementById('selected_seats_display');
        const seatIdsContainer = document.getElementById('seat_ids_container');
        const ladiesWarning = document.getElementById('ladies_seat_warning');

        const GST = JSON.parse(document.getElementById('gstData').textContent);
        const FEE = JSON.parse(document.getElementById('feeData').textContent);
        const bookedSeatIds = JSON.parse(document.getElementById('bookedSeatsData').textContent);

        // Disable booked seats
        seatCheckboxes.forEach(checkbox => {
            if (bookedSeatIds.includes(parseInt(checkbox.value))) {
                checkbox.disabled = true;
                checkbox.parentElement.classList.add('booked');
            }
        });

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        if (travelDate) {
            travelDate.min = todayStr;
            if (!travelDate.value) travelDate.value = todayStr;
        }

        function getSelectedSeats() {
            const selected = Array.from(seatCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => ({
                    id: checkbox.value,
                    number: checkbox.dataset.number,
                    reserved: checkbox.dataset.gender
                }));
            return selected;
        }

        function updateSeatDisplay() {
            const selected = getSelectedSeats();
            if (selected.length === 0) {
                selectedSeatsDisplay.innerHTML = '<span class="text-muted">No seats selected</span>';
                if (bookNowBtn) bookNowBtn.disabled = true;
            } else {
                const seatNumbers = selected.map(s => s.number).join(', ');
                selectedSeatsDisplay.textContent = `${selected.length} seat(s): ${seatNumbers}`;
                if (bookNowBtn) bookNowBtn.disabled = false;
            }
            updatePricing();
        }

        function updatePricing() {
            const selected = getSelectedSeats();
            const numSeats = selected.length;
            const selected_el = routeSelect.options[routeSelect.selectedIndex];
            const fare = parseFloat(selected_el.dataset.fare || '0');
            const base = fare * numSeats;
            const fee = base * (FEE / 100);
            const gst = (base + fee) * (GST / 100);
            const total = base + fee + gst;

            baseFareEl.textContent = (fare * numSeats).toFixed(0);
            convFeeEl.textContent = fee.toFixed(0);
            gstEl.textContent = gst.toFixed(0);
            totalEl.textContent = total.toFixed(0);
        }



        function updateHiddenInputs() {
            const selected = getSelectedSeats();
            seatIdsContainer.innerHTML = '';
            selected.forEach(seat => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'seat_ids';
                input.value = seat.id;
                seatIdsContainer.appendChild(input);
            });
        }

        // Event listeners
        seatCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const label = document.querySelector(`label[for="${this.id}"]`);
                if (this.checked) {
                    label.classList.add('selected');
                } else {
                    label.classList.remove('selected');
                }
                updateSeatDisplay();
                validateLadiesSeats();
                updateHiddenInputs();
            });
        });

        routeSelect.addEventListener('change', function() {
            const params = new URLSearchParams(window.location.search);
            params.set('route_id', this.value);
            if (travelDate && travelDate.value) {
                params.set('travel_date', travelDate.value);
            }
            window.location.href = `${window.location.pathname}?${params.toString()}`;
        });

        genderSelect.addEventListener('change', validateLadiesSeats);

        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            const selected = getSelectedSeats();
            const gender = document.getElementById('passenger_gender').value;
            
            if (selected.length === 0) {
                e.preventDefault();
                alert('Please select at least one seat');
                return false;
            }
            
            // Validate ladies seat restrictions before submit
            let invalidSeats = selected.filter(s => s.reserved === 'ladies' && gender !== 'F');
            if (invalidSeats.length > 0) {
                e.preventDefault();
                alert(`Seats ${invalidSeats.map(s => s.number).join(', ')} are reserved for female passengers. Please select different seats.`);
                return false;
            }
            
            validateLadiesSeats();
        });

        updateSeatDisplay();
    });
</script>
<script src="{% static 'js/booking-utilities.js' %}"></script>
{% endblock %}
