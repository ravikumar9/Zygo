{% extends 'base.html' %}
{% load static %}

{% block title %}{{ property.name }} - Property Details{% endblock %}

{% block extra_css %}
<style>
    .property-detail-container {
        max-width: 900px;
        margin: 30px auto;
        padding: 0 15px;
    }
    
    .status-badge {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 20px;
    }
    
    .status-draft {
        background-color: #f0f0f0;
        color: #333;
        border-left: 4px solid #6C757D;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #FFC107;
    }
    
    .status-approved {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28A745;
    }
    
    .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #DC3545;
    }
    
    .property-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .property-header h1 {
        margin: 0 0 5px 0;
        font-size: 28px;
        font-weight: 700;
    }
    
    .property-meta {
        display: flex;
        gap: 20px;
        font-size: 14px;
        color: #666;
        margin-top: 10px;
    }
    
    .info-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .info-section h3 {
        margin-top: 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 12px;
    }
    
    .info-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 20px;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-row:last-child {
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #666;
    }
    
    .info-value {
        color: #333;
    }
    
    .completion-bar {
        background: #f0f0f0;
        border-radius: 20px;
        height: 8px;
        margin: 10px 0;
        overflow: hidden;
    }
    
    .completion-fill {
        background: linear-gradient(90deg, #28A745, #20C997);
        height: 100%;
        border-radius: 20px;
    }
    
    .checklist-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        font-size: 14px;
    }
    
    .checklist-icon {
        margin-right: 10px;
        font-size: 16px;
        min-width: 20px;
    }
    
    .checklist-complete .checklist-icon {
        color: #28A745;
    }
    
    .checklist-incomplete .checklist-icon {
        color: #DC3545;
    }
    
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .btn-primary {
        background-color: #00BCD4;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s ease;
    }
    
    .btn-primary:hover {
        background-color: #0097A7;
    }
    
    .btn-secondary {
        background-color: #6C757D;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s ease;
    }
    
    .btn-secondary:hover {
        background-color: #5A6268;
    }
    
    .rejection-box {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-left: 4px solid #DC3545;
        padding: 15px 20px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .rejection-box h4 {
        margin-top: 0;
        color: #721c24;
    }
    
    .rejection-box p {
        margin: 0;
        color: #721c24;
        line-height: 1.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="property-detail-container">
    <div class="property-header">
        <div>
            <h1>{{ property.name }}</h1>
            <div class="property-meta">
                <span>üìç {{ property.city.name }}</span>
                <span>üè† {{ property.get_property_type_display }}</span>
                <span>üõèÔ∏è {{ property.room_types.count }} type(s) / {{ property.total_room_inventory }} room(s)</span>
                <span>Updated: {{ property.updated_at|date:"M d, Y" }}</span>
            </div>
        </div>
        <div>
            <div class="status-badge status-{{ property.status|lower }}">
                {% if property.status == 'DRAFT' %}
                    üìù DRAFT
                {% elif property.status == 'PENDING' %}
                    ‚è≥ PENDING REVIEW
                {% elif property.status == 'APPROVED' %}
                    ‚úÖ APPROVED
                {% elif property.status == 'REJECTED' %}
                    ‚ùå REJECTED
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- REJECTION NOTICE -->
    {% if property.status == 'REJECTED' and property.rejection_reason %}
    <div class="rejection-box">
        <h4>‚ùå Property Rejected</h4>
        <p>{{ property.rejection_reason }}</p>
        <p style="margin-top: 10px; font-size: 13px;">
            You can edit your property and resubmit it for approval.
        </p>
    </div>
    {% endif %}

    <!-- UPDATE REQUEST (post-approval changes) -->
    <div class="info-section" id="updateSection">
        <h3>üîÑ Submit Update Request</h3>
        <p style="color:#666;">Owners can request changes without re-registering. All changes require admin approval.</p>
        <div class="form-row" style="display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width:220px;">
                <label for="changeType">Change Type</label>
                <select id="changeType" data-testid="owner-update-change-type" style="width:100%; padding:10px;">
                    <option value="rules">Property Rules</option>
                    <option value="amenities">Amenities</option>
                    <option value="pricing">Room Pricing</option>
                    <option value="meal_plans">Meal Plans</option>
                    <option value="discount">Property Discount</option>
                </select>
            </div>
            <div style="flex:1; min-width:220px;">
                <label for="roomSelect">Room (optional)</label>
                <select id="roomSelect" data-testid="owner-update-room-select" style="width:100%; padding:10px;">
                    <option value="">Whole Property</option>
                    {% for room in property.room_types.all %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-row" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width:220px;">
                <label for="priceInput">New Base Price (‚Çπ)</label>
                <input type="number" id="priceInput" style="width:100%; padding:10px;" placeholder="5000">
            </div>
            <div style="flex:1; min-width:220px;">
                <label for="amenitiesInput">Amenities (comma separated)</label>
                <input type="text" id="amenitiesInput" style="width:100%; padding:10px;" placeholder="WiFi, Parking, AC">
            </div>
        </div>
        <div class="form-group" style="margin-top:10px;">
            <label for="rulesInput">Property Rules / Notes</label>
            <textarea id="rulesInput" rows="3" style="width:100%; padding:10px;" placeholder="Updated rules after renovation"></textarea>
        </div>
        <div class="form-group" style="margin-top:10px;">
            <label for="ownerRemark">Reason / Remarks</label>
            <textarea id="ownerRemark" rows="2" style="width:100%; padding:10px;" data-testid="owner-update-remarks" placeholder="Why are you requesting this change?"></textarea>
        </div>
        <div class="button-group">
            <button class="btn-primary" id="submitUpdateBtn" data-testid="owner-update-submit">Submit Update Request</button>
            <div id="updateAlert" class="alert" style="display:none; margin-left:10px;"></div>
        </div>
    </div>
    
    <!-- COMPLETION STATUS -->
    {% if property.status == 'DRAFT' %}
    <div class="info-section" style="background: #f8f9fa; border: 1px solid #dee2e6;">
        <h3>üìä Completion Status</h3>
        <p style="color: #666;">
            {% if is_complete %}
                ‚úÖ <strong>All sections complete!</strong> Your property is ready to submit for approval.
            {% else %}
                üìù Complete remaining sections to submit your property.
            {% endif %}
        </p>
        <div style="font-size: 20px; font-weight: 700; color: #00BCD4; margin-bottom: 10px;">
            {{ completion_percentage }}% Complete
        </div>
        <div class="completion-bar">
            <div class="completion-fill" style="width: 100%;" data-percentage="{{ completion_percentage }}"></div>
        </div>
        
        <h4 style="margin-top: 20px; margin-bottom: 10px;">Required Fields:</h4>
        {% for field, complete in required_checks.items %}
        <div class="checklist-item {% if complete %}checklist-complete{% else %}checklist-incomplete{% endif %}">
            <span class="checklist-icon">{% if complete %}‚úÖ{% else %}‚ùå{% endif %}</span>
            {{ field|title }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- BASIC INFORMATION -->
    <div class="info-section">
        <h3>üè¢ Basic Information</h3>
        <div class="info-row">
            <div class="info-label">Property Name:</div>
            <div class="info-value">{{ property.name }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Type:</div>
            <div class="info-value">{{ property.get_property_type_display }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Description:</div>
            <div class="info-value">{{ property.description }}</div>
        </div>
    </div>
    
    <!-- LOCATION -->
    <div class="info-section">
        <h3>üìç Location</h3>
        <div class="info-row">
            <div class="info-label">City:</div>
            <div class="info-value">{{ property.city.name }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Address:</div>
            <div class="info-value">{{ property.address }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">State:</div>
            <div class="info-value">{{ property.state }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Pincode:</div>
            <div class="info-value">{{ property.pincode }}</div>
        </div>
    </div>
    
    <!-- CONTACT -->
    <div class="info-section">
        <h3>üìû Contact Information</h3>
        <div class="info-row">
            <div class="info-label">Phone:</div>
            <div class="info-value">{{ property.contact_phone }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Email:</div>
            <div class="info-value">{{ property.contact_email }}</div>
        </div>
    </div>
    
    <!-- RULES & POLICIES -->
    <div class="info-section">
        <h3>üìã Rules & Policies</h3>
        <div class="info-row">
            <div class="info-label">Check-in:</div>
            <div class="info-value">{{ property.checkin_time|time:"H:i" }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Check-out:</div>
            <div class="info-value">{{ property.checkout_time|time:"H:i" }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">House Rules:</div>
            <div class="info-value">{{ property.property_rules }}</div>
        </div>
    </div>
    
    <!-- CAPACITY -->
    <div class="info-section">
        <h3>üõèÔ∏è Capacity & Layout</h3>
        <div class="info-row">
            <div class="info-label">Max Guests:</div>
            <div class="info-value">{{ property.max_guests }} person(s)</div>
        </div>
        <div class="info-row">
            <div class="info-label">Bedrooms:</div>
            <div class="info-value">{{ property.num_bedrooms }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Bathrooms:</div>
            <div class="info-value">{{ property.num_bathrooms }}</div>
        </div>
    </div>
    
    <!-- PRICING -->
    <div class="info-section">
        <h3>üí∞ Pricing</h3>
        <div class="info-row">
            <div class="info-label">Price/Night:</div>
            <div class="info-value">‚Çπ{{ property.base_price|floatformat:2 }} {{ property.currency }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">GST:</div>
            <div class="info-value">{{ property.gst_percentage }}%</div>
        </div>
    </div>

    <!-- ROOM TYPES & INVENTORY -->
    <div class="info-section">
        <h3>üõèÔ∏è Room Types & Inventory</h3>
        {% if property.room_types.all|length %}
            {% for room in property.room_types.all %}
            <div class="info-row" style="grid-template-columns: 200px 1fr;">
                <div class="info-label">{{ room.name }}</div>
                <div class="info-value">
                    <div>Type: {{ room.get_room_type_display }} | Max {{ room.max_occupancy }} guest(s)</div>
                    <div>Inventory: {{ room.total_rooms }} room(s)</div>
                    <div>
                        Price: ‚Çπ{{ room.base_price|floatformat:2 }}
                        {% if room.has_discount %}
                            <span class="text-decoration-line-through text-muted">‚Çπ{{ room.base_price|floatformat:2 }}</span>
                            <strong class="text-success">‚Çπ{{ room.get_effective_price|floatformat:2 }}</strong>
                            {% if room.discount_valid_to %}<small class="text-muted">valid till {{ room.discount_valid_to }}</small>{% endif %}
                        {% endif %}
                    </div>
                    {% if room.amenities %}
                    <div class="mt-2 small text-muted">Amenities:
                        {% for amenity in room.amenities %}
                            <span class="badge bg-light text-dark border">{{ amenity|title }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if room.images.all %}
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        {% for img in room.images.all|slice:':3' %}
                        <img src="{{ img.image.url }}" alt="{{ room.name }} image" class="img-thumbnail" style="max-width:120px;" onerror="this.src='{% static 'images/room_placeholder.svg' %}'">
                        {% endfor %}
                        {% if room.images.count > 3 %}<small class="text-muted">+{{ room.images.count|add:'-3' }} more</small>{% endif %}
                    </div>
                    {% endif %}
                    {% if property.status == 'APPROVED' %}
                    <div class="mt-2">
                        <a href="{% url 'property_owners:edit-room-live' property.id room.id %}" class="btn btn-sm btn-warning" style="background: #ffc107; color: #333; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem;">
                            ‚ö° Edit Price/Discount/Inventory
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="rejection-box" style="margin:0;">
                <h4>üö´ No Room Types Added</h4>
                <p>Add at least one room type with inventory to submit for approval.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- AMENITIES -->
    {% if property.has_wifi or property.has_parking or property.has_pool or property.has_gym or property.has_restaurant or property.has_spa or property.has_ac %}
    <div class="info-section">
        <h3>‚ú® Amenities</h3>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            {% if property.has_wifi %}<div>üì∂ WiFi</div>{% endif %}
            {% if property.has_parking %}<div>üÖøÔ∏è Parking</div>{% endif %}
            {% if property.has_pool %}<div>üèä Pool</div>{% endif %}
            {% if property.has_gym %}<div>üí™ Gym</div>{% endif %}
            {% if property.has_restaurant %}<div>üçΩÔ∏è Restaurant</div>{% endif %}
            {% if property.has_spa %}<div>üßñ Spa</div>{% endif %}
            {% if property.has_ac %}<div>‚ùÑÔ∏è Air Conditioning</div>{% endif %}
        </div>
    </div>
    {% endif %}
    
    <!-- CANCELLATION POLICY -->
    <div class="info-section">
        <h3>‚ùå Cancellation Policy</h3>
        <div class="info-row">
            <div class="info-label">Type:</div>
            <div class="info-value">{{ property.get_cancellation_type_display }}</div>
        </div>
        {% if property.cancellation_days %}
        <div class="info-row">
            <div class="info-label">Days:</div>
            <div class="info-value">{{ property.cancellation_days }} day(s) before check-in</div>
        </div>
        {% endif %}
        <div class="info-row">
            <div class="info-label">Refund %:</div>
            <div class="info-value">{{ property.refund_percentage }}%</div>
        </div>
        <div class="info-row">
            <div class="info-label">Policy:</div>
            <div class="info-value">{{ property.cancellation_policy }}</div>
        </div>
    </div>
    
    <!-- ACTION BUTTONS -->
    <div class="button-group">
        {% if can_edit %}
            <a href="{% url 'property_owners:create_property' %}?edit={{ property.id }}" class="btn-primary">
                ‚úèÔ∏è Edit Property
            </a>
        {% endif %}
        
        {% if can_resubmit %}
            <a href="{% url 'property_owners:create_property' %}?edit={{ property.id }}" class="btn-primary">
                üîÑ Edit & Resubmit
            </a>
        {% endif %}
        
        <a href="{% url 'property_owners:dashboard' %}" class="btn-secondary">
            ‚Üê Back to Dashboard
        </a>
    </div>
</div>

<script>
    (function() {
        const btn = document.getElementById('submitUpdateBtn');
        if (!btn) return;
        const alertBox = document.getElementById('updateAlert');

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        btn.addEventListener('click', async () => {
            alertBox.style.display = 'none';
            const changeType = document.getElementById('changeType').value;
            const roomId = document.getElementById('roomSelect').value;
            const ownerRemark = document.getElementById('ownerRemark').value.trim();
            const price = document.getElementById('priceInput').value;
            const amenities = document.getElementById('amenitiesInput').value;
            const rules = document.getElementById('rulesInput').value;

            const newData = {};
            if (price) newData.base_price = price;
            if (amenities) newData.amenities = amenities;
            if (rules) newData.property_rules = rules;

            const payload = {
                change_type: changeType,
                room_id: roomId || null,
                owner_remark: ownerRemark,
                new_data: newData,
            };

            try {
                const res = await fetch(`/properties/api/property-owners/properties/{{ property.id }}/updates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(payload),
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    alertBox.className = 'alert alert-danger';
                    alertBox.textContent = data.error || 'Update request failed';
                    alertBox.style.display = 'block';
                    return;
                }
                alertBox.className = 'alert alert-success';
                alertBox.textContent = 'Update request submitted and pending approval';
                alertBox.style.display = 'block';
            } catch (e) {
                alertBox.className = 'alert alert-danger';
                alertBox.textContent = 'Network error submitting update';
                alertBox.style.display = 'block';
            }
        });
    })();
</script>
{% endblock %}
