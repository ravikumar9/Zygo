{% extends "base.html" %}
{% load static %}
{% load core_extras %}

{% block title %}Hotels - GoExplorer{% endblock %}

{% block content %}
<div class="container my-5">
    <h1>Hotels</h1>
    {% if search_error %}
    <div class="alert alert-danger" id="search-error">{{ search_error }}</div>
    {% endif %}
    <form method="get" class="card shadow-sm border-0 p-3 mb-4" id="hotel-search-form">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Search (city, area, property)</label>
                <input type="text" name="search" class="form-control" placeholder="e.g. Koramangala or Palm" value="{{ search_query|default:'' }}">
                <input type="hidden" name="q" id="searchAliasQ" value="{{ search_query|default:'' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">City</label>
                <select name="city_id" class="form-select">
                    <option value="">Select City</option>
                    {% for city in cities %}
                    <option value="{{ city.id }}" {% if selected_city == city.id|stringformat:'s' %}selected{% endif %}>{{ city.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Property Type</label>
                <select name="property_type" class="form-select">
                    <option value="">Any</option>
                    {% for code,label in property_types %}
                    <option value="{{ code }}" {% if selected_property_type == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Star Rating</label>
                <select name="star_rating" class="form-select">
                    <option value="">Any</option>
                    {% for i in "12345" %}
                    <option value="{{ forloop.counter }}" {% if selected_star_rating == forloop.counter|stringformat:'s' %}selected{% endif %}>{{ forloop.counter }} Star</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row g-3 mt-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Check-in</label>
                <input type="date" name="checkin" class="form-control" value="{{ selected_checkin|default:'' }}" min="{{ today }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Check-out</label>
                <input type="date" name="checkout" class="form-control" value="{{ selected_checkout|default:'' }}" min="{{ today }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Guests</label>
                <input type="number" name="guests" class="form-control" min="1" value="{{ selected_guests|default:1 }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Min Price</label>
                <input type="number" name="price_min" class="form-control" min="0" value="{{ selected_price_min|default:'' }}" placeholder="0">
            </div>
            <div class="col-md-2">
                <label class="form-label">Max Price</label>
                <input type="number" name="price_max" class="form-control" min="0" value="{{ selected_price_max|default:'' }}" placeholder="15000">
            </div>
        </div>

        <div class="row g-3 mt-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label">Amenities</label>
                <div class="d-flex flex-wrap gap-2 small">
                    <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" name="has_wifi" value="true" {% if selected_amenities.has_wifi %}checked{% endif %}><span class="form-check-label">Wifi</span></label>
                    <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" name="has_parking" value="true" {% if selected_amenities.has_parking %}checked{% endif %}><span class="form-check-label">Parking</span></label>
                    <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" name="has_pool" value="true" {% if selected_amenities.has_pool %}checked{% endif %}><span class="form-check-label">Pool</span></label>
                    <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" name="has_gym" value="true" {% if selected_amenities.has_gym %}checked{% endif %}><span class="form-check-label">Gym</span></label>
                    <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" name="has_restaurant" value="true" {% if selected_amenities.has_restaurant %}checked{% endif %}><span class="form-check-label">Restaurant</span></label>
                    <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" name="has_spa" value="true" {% if selected_amenities.has_spa %}checked{% endif %}><span class="form-check-label">Spa</span></label>
                    <label class="form-check form-check-inline mb-0"><input class="form-check-input" type="checkbox" name="has_ac" value="true" {% if selected_amenities.has_ac %}checked{% endif %}><span class="form-check-label">AC</span></label>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Sort</label>
                <select name="sort" class="form-select">
                    <option value="">Default</option>
                    <option value="price_asc" {% if selected_sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_desc" {% if selected_sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                    <option value="rating_desc" {% if selected_sort == 'rating_desc' %}selected{% endif %}>Rating: High to Low</option>
                    <option value="rating_asc" {% if selected_sort == 'rating_asc' %}selected{% endif %}>Rating: Low to High</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Near Me</label>
                <button type="button" class="btn btn-outline-secondary w-100" id="nearMeBtn">Use my location</button>
                <small class="text-muted d-block">Radius {{ selected_radius|default:'10' }} km</small>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-primary w-100" type="submit">Search</button>
                <a href="/hotels/" class="small d-inline-block mt-2">Reset filters</a>
            </div>
        </div>

        <input type="hidden" name="near_me" id="nearMeFlag" value="{% if selected_near_me %}1{% else %}0{% endif %}">
        <input type="hidden" name="lat" id="nearMeLat" value="{{ selected_lat|default:'' }}">
        <input type="hidden" name="lng" id="nearMeLng" value="{{ selected_lng|default:'' }}">
        <input type="hidden" name="radius" id="nearMeRadius" value="{{ selected_radius|default:'10' }}">
    </form>

    {% if near_me_notice %}
    <div class="alert alert-info mt-3" role="alert">
        <i class="fas fa-info-circle me-1"></i>{{ near_me_notice }}
    </div>
    {% endif %}

    {% if hotels %}
    <div class="row g-4">
        {% for hotel in hotels %}
        <div class="col-md-4">
            <div class="card h-100 shadow-sm">
                <img src="{{ hotel.display_image_url }}" class="card-img-top" alt="{{ hotel.name }}" style="height:200px;object-fit:cover;" data-fallback="{% static 'images/hotel_placeholder.svg' %}">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-primary text-uppercase small">{{ hotel.get_property_type_display }}</span>
                        <span class="badge bg-warning text-dark small"><i class="fas fa-star me-1"></i>{{ hotel.star_rating }}</span>
                    </div>
                    <h5 class="mb-1">{{ hotel.name }}</h5>
                    <p class="text-muted small mb-2 d-flex justify-content-between">
                        <span><i class="fas fa-map-marker-alt me-1"></i>{{ hotel.city.name }}</span>
                        {% if hotel.distance_km %}<span class="badge bg-success-subtle text-success border">{{ hotel.distance_km }} km</span>{% endif %}
                    </p>
                    <!-- FIX-3: Price Display (Search Results - No GST) -->
                    <div class="mb-2">
                        <p class="small text-muted mb-1">From <strong style="color: #FF6B35;">â‚¹{{ hotel.min_price|default:0|floatformat:'0' }}</strong>/night</p>
                        {% if hotel.discount_badge %}
                        <span class="badge bg-danger">{{ hotel.discount_badge }}</span>
                        {% endif %}
                        {% if hotel.hourly_stays_enabled %}
                        <span class="badge bg-info text-dark" title="Hourly Stays Available"><i class="fas fa-clock me-1"></i> Hourly Stays Available</span>
                        {% endif %}
                    </div>
                    <div class="d-flex flex-wrap gap-2 mb-3 small text-muted">
                        {% if hotel.has_wifi %}<span><i class="fas fa-wifi"></i></span>{% endif %}
                        {% if hotel.has_parking %}<span><i class="fas fa-square-parking"></i></span>{% endif %}
                        {% if hotel.has_pool %}<span><i class="fas fa-person-swimming"></i></span>{% endif %}
                        {% if hotel.has_gym %}<span><i class="fas fa-dumbbell"></i></span>{% endif %}
                        {% if hotel.has_restaurant %}<span><i class="fas fa-utensils"></i></span>{% endif %}
                        {% if hotel.has_spa %}<span><i class="fas fa-spa"></i></span>{% endif %}
                        {% if hotel.has_ac %}<span><i class="fas fa-wind"></i></span>{% endif %}
                    </div>
                    <!-- Ensure detail link matches Playwright selector and detail route -->
                    <a href="{% url 'hotels:hotel_detail_alias' hotel.id %}?{{ request.GET.urlencode }}"
                       class="btn btn-primary mt-auto"
                       data-testid="hotel-card"
                       data-hotel-id="{{ hotel.id }}">
                        View &amp; Book
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        No hotels found for the selected criteria
    </div>
    {% endif %}
</div>

<script>
let nearMeRetry = false;

document.addEventListener('DOMContentLoaded', () => {
    // Set minimum date to today for check-in and check-out on search form
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const minDate = `${year}-${month}-${day}`;
    
    const checkinInput = document.querySelector('input[name="checkin"]');
    const checkoutInput = document.querySelector('input[name="checkout"]');
    
    if (checkinInput) {
        checkinInput.min = minDate;
    }
    if (checkoutInput) {
        checkoutInput.min = minDate;
    }

    const searchForm = document.querySelector('form');
    const searchError = document.getElementById('search-error');
    if (searchForm) {
        searchForm.addEventListener('submit', (e) => {
            // Mirror 'search' to 'q' for backend compatibility
            const searchInput = document.querySelector('input[name="search"]');
            const qAlias = document.getElementById('searchAliasQ');
            if (searchInput && qAlias) { qAlias.value = searchInput.value || ''; }
            if (checkinInput && checkoutInput && checkinInput.value && checkoutInput.value) {
                const inDate = new Date(checkinInput.value);
                const outDate = new Date(checkoutInput.value);
                if (outDate <= inDate) {
                    e.preventDefault();
                    const message = 'Check-out must be after check-in.';
                    if (searchError) {
                        searchError.textContent = message;
                        searchError.classList.remove('alert-info');
                        searchError.classList.add('alert-danger');
                    } else {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-danger';
                        alert.id = 'search-error';
                        alert.textContent = message;
                        searchForm.parentElement.insertBefore(alert, searchForm);
                    }
                }
            }
        });
    }

    const nearMeBtn = document.getElementById('nearMeBtn');
    const nearMeFlag = document.getElementById('nearMeFlag');
    const nearMeLat = document.getElementById('nearMeLat');
    const nearMeLng = document.getElementById('nearMeLng');
    if (nearMeBtn && nearMeFlag && nearMeLat && nearMeLng) {
        nearMeBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                if (searchError) {
                    searchError.textContent = 'Geolocation is not supported on this browser.';
                    searchError.classList.add('alert-danger');
                    searchError.classList.remove('alert-info');
                } else if (searchForm) {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger';
                    alert.id = 'search-error';
                    alert.textContent = 'Geolocation is not supported on this browser.';
                    searchForm.parentElement.insertBefore(alert, searchForm);
                }
                return;
            }
            nearMeBtn.disabled = true;
            nearMeBtn.textContent = 'Locating...';
            navigator.geolocation.getCurrentPosition((pos) => {
                nearMeLat.value = pos.coords.latitude.toFixed(6);
                nearMeLng.value = pos.coords.longitude.toFixed(6);
                nearMeFlag.value = '1';
                searchForm.submit();
            }, (err) => {
                nearMeBtn.disabled = false;
                nearMeBtn.textContent = 'Use my location';
                if (!nearMeRetry) {
                    nearMeRetry = true;
                    if (searchError) {
                        searchError.textContent = 'Location permission denied. Tap Near Me again to retry or we will show city results.';
                        searchError.classList.add('alert-danger');
                        searchError.classList.remove('alert-info');
                    } else if (searchForm) {
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-danger';
                        alert.id = 'search-error';
                        alert.textContent = 'Location permission denied. Tap Near Me again to retry or we will show city results.';
                        searchForm.parentElement.insertBefore(alert, searchForm);
                    }
                } else {
                    nearMeFlag.value = '0';
                    searchForm.submit();
                }
            }, { enableHighAccuracy: true, timeout: 8000 });
        });
    }
});
</script>
{% endblock %}
