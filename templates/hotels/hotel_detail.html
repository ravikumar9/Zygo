{% extends "base.html" %}
{% load static %}

{% block title %}{{ hotel.name }} - Booking{% endblock %}

{% block content %}
<div class="container" style="margin-top: 2rem; margin-bottom: 3rem;">
    
    <!-- ============================================================================ -->
    <!-- HEADER SECTION -->
    <!-- ============================================================================ -->
    <div class="row mb-4">
        <div class="col-md-8">
            <!-- Hotel Name & Rating -->
            <h1 style="color: #222; margin-bottom: 0.5rem;" data-testid="hotel-name">
                {{ hotel.name }}
                <span style="color: #FF6B35; font-size: 1rem;">
                    {% for i in "12345" %}
                        {% if forloop.counter <= hotel.star_rating %}
                        <i class="fas fa-star"></i>
                        {% else %}
                        <i class="fas fa-star" style="color: #ddd;"></i>
                        {% endif %}
                    {% endfor %}
                </span>
            </h1>
            
            <!-- Location -->
            <p style="color: #666; margin-bottom: 1rem;">
                <i class="fas fa-map-marker-alt"></i> {{ hotel.address }}, {{ hotel.city.name }}
            </p>
            
            <!-- Review Rating -->
            {% if hotel.review_rating %}
            <div style="margin-bottom: 1rem;">
                <span style="background-color: #FF6B35; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600;">
                    {{ hotel.review_rating }} / 5.0
                </span>
                <span style="color: #666; margin-left: 0.5rem;">
                    Based on {{ hotel.review_count }} reviews
                </span>
            </div>
            {% endif %}
            
            <!-- Images Gallery (Goibibo-style): Hero + secondary grid + CTA -->
            <div class="row" style="margin-bottom: 2rem;">
                <div class="col-md-8">
                    <div style="border-radius: 8px; overflow: hidden; position: relative;">
                        <img src="{{ hotel.display_image_url }}"
                             alt="{{ hotel.name }}"
                             class="img-fluid"
                             style="width: 100%; height: 420px; object-fit: cover;"
                             onerror="this.src='{% static 'images/hotel_placeholder.svg' %}'">
                        {% if hotel.images.count %}
                        <span class="badge bg-dark" style="position:absolute; bottom:10px; right:10px; opacity:0.85;">Hero</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="row g-2">
                        {% for img in hotel.images.all|slice:":4" %}
                        <div class="col-6">
                            <div style="border-radius:6px; overflow:hidden; height: 100px;">
                                <img src="{{ img.get_url_with_cache_busting }}" alt="{{ img.caption|default:hotel.name }}"
                                     style="width:100%; height:100%; object-fit:cover;"
                                     onerror="this.src='{% static 'images/hotel_placeholder.svg' %}'">
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-muted small">No additional photos</div>
                        {% endfor %}
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-primary btn-sm" id="viewAllPhotosBtn">
                            View All Photos ({{ hotel.images.count }})
                        </button>
                        {% if hotel.hourly_stays_enabled %}
                        <span class="badge bg-info text-dark"><i class="fas fa-clock"></i> Hourly Stays Available</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Pricing Widget -->
            {% include "hotels/includes/pricing-calculator.html" %}
            
            <!-- Booking Form -->
            {% include "hotels/includes/booking-form.html" %}
        </div>
    </div>
    
    <!-- ============================================================================ -->
    <!-- DETAILS SECTION (2 Columns) -->
    <!-- ============================================================================ -->
    <div class="row">
        <div class="col-md-8">
            
            <!-- ================================================================= -->
            <!-- ABOUT SECTION (Hotel Policy - Shows Once) -->
            <!-- ================================================================= -->
            <div style="margin-bottom: 3rem;">
                <h3 style="color: #222; margin-bottom: 1.5rem; border-bottom: 2px solid #FF6B35; padding-bottom: 0.5rem;">
                    <i class="fas fa-info-circle"></i> About This Property
                </h3>
                
                <!-- Hotel Description -->
                {% if hotel.description %}
                <p style="color: #555; line-height: 1.6; margin-bottom: 1.5rem;">
                    {{ hotel.description }}
                </p>
                {% endif %}
                
                <!-- Property Rules -->
                {% if hotel.property_rules %}
                <div style="background-color: #f9f9f9; padding: 1rem; border-left: 4px solid #FF6B35; margin-bottom: 1.5rem;">
                    <h5 style="color: #222; margin-bottom: 0.5rem;">Property Rules</h5>
                    <p style="color: #555; margin: 0;">{{ hotel.property_rules }}</p>
                </div>
                {% endif %}
                
                <!-- Amenities Rules -->
                {% if hotel.amenities_rules %}
                <div style="background-color: #f9f9f9; padding: 1rem; border-left: 4px solid #FF6B35; margin-bottom: 1.5rem;">
                    <h5 style="color: #222; margin-bottom: 0.5rem;">Amenities & Services</h5>
                    <p style="color: #555; margin: 0;">{{ hotel.amenities_rules }}</p>
                </div>
                {% endif %}
                
                <!-- Inventory Source Badge (TRUST UX) -->
                <div style="background-color: {% if hotel.inventory_source == 'internal_cm' %}#e8f5e9{% else %}#fff3e0{% endif %}; padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1.5rem; display: inline-block;">
                    {% if hotel.inventory_source == 'internal_cm' %}
                        <i class="fas fa-check-circle" style="color: #4caf50;"></i>
                        <strong style="color: #2e7d32;">Managed by GoExplorer</strong> — Real-time availability
                    {% else %}
                        <i class="fas fa-sync-alt" style="color: #ff9800;"></i>
                        <strong style="color: #e65100;">Live Inventory</strong> — Availability may change
                        {% if hotel.channel_manager_name %}
                            <span style="color: #666; font-size: 0.9rem;">(via {{ hotel.channel_manager_name }})</span>
                        {% endif %}
                    {% endif %}
                </div>
                
                <!-- Cancellation Policy (Shows Once) -->
                {% include "hotels/includes/cancellation-policy.html" %}
            </div>
            
            <!-- ================================================================= -->
            <!-- ROOMS SECTION (with Meal Plans Data) -->
            <!-- ================================================================= -->
            <div style="margin-bottom: 3rem;">
                <h3 style="color: #222; margin-bottom: 1.5rem; border-bottom: 2px solid #FF6B35; padding-bottom: 0.5rem;">
                    <i class="fas fa-door-open"></i> Available Rooms
                </h3>
                
                <!-- Meal Plans JSON (Hidden) -->
                {% include "hotels/includes/meal-plans-data.html" %}
                
                <!-- Room Cards -->
                <div id="available-rooms">
                    {% include "hotels/includes/room-card.html" %}
                </div>
            </div>
            
            <!-- ================================================================= -->
            <!-- PROPERTY POLICIES (Goibibo-Style Accordion) -->
            <!-- ================================================================= -->
            {% if policies_by_category %}
            <div style="margin-bottom: 3rem;">
                <h3 style="color: #222; margin-bottom: 1.5rem; border-bottom: 2px solid #FF6B35; padding-bottom: 0.5rem;">
                    <i class="fas fa-file-contract"></i> Property Policies
                </h3>
                
                <div class="accordion" id="policiesAccordion">
                    {% for category, policies in policies_by_category.items %}
                    <div class="card" style="border: 1px solid #e0e0e0; border-radius: 0; margin-bottom: 0.5rem;">
                        <div class="card-header" id="heading{{ forloop.counter }}" style="background-color: #f9f9f9; padding: 0;">
                            <h5 style="margin: 0;">
                                <button class="btn btn-link" 
                                        type="button" 
                                        data-toggle="collapse" 
                                        data-target="#collapse{{ forloop.counter }}" 
                                        aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                                        aria-controls="collapse{{ forloop.counter }}"
                                        style="width: 100%; text-align: left; text-decoration: none; color: #333; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                                    <span>
                                        <i class="{{ category.icon_class }}" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                                        {{ category.get_category_type_display }}
                                    </span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </h5>
                        </div>
                        
                        <div id="collapse{{ forloop.counter }}" 
                             class="collapse {% if forloop.first %}show{% endif %}" 
                             aria-labelledby="heading{{ forloop.counter }}" 
                             data-parent="#policiesAccordion">
                            <div class="card-body" style="padding: 1.5rem; background-color: #fff;">
                                {% for policy in policies %}
                                <div style="margin-bottom: 1rem; {% if policy.is_highlighted %}border-left: 3px solid #FF6B35; padding-left: 1rem; background-color: #fff5f0;{% endif %}">
                                    <h6 style="color: #222; font-weight: 600; margin-bottom: 0.5rem;">
                                        {% if policy.is_highlighted %}<i class="fas fa-star" style="color: #FF6B35;"></i> {% endif %}
                                        {{ policy.label }}
                                    </h6>
                                    <p style="color: #666; margin: 0; line-height: 1.6;">{{ policy.description }}</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- ================================================================= -->
            <!-- AMENITIES SECTION -->
            <!-- ================================================================= -->
            <div style="margin-bottom: 3rem;">
                <h3 style="color: #222; margin-bottom: 1.5rem; border-bottom: 2px solid #FF6B35; padding-bottom: 0.5rem;">
                    <i class="fas fa-heartbeat"></i> Amenities
                </h3>
                
                <div class="row">
                    {% if hotel.has_wifi %}
                    <div class="col-md-4 mb-3">
                        <p style="color: #555;">
                            <i class="fas fa-wifi" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                            Free WiFi
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if hotel.has_parking %}
                    <div class="col-md-4 mb-3">
                        <p style="color: #555;">
                            <i class="fas fa-parking" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                            Parking Available
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if hotel.has_pool %}
                    <div class="col-md-4 mb-3">
                        <p style="color: #555;">
                            <i class="fas fa-swimming-pool" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                            Swimming Pool
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if hotel.has_gym %}
                    <div class="col-md-4 mb-3">
                        <p style="color: #555;">
                            <i class="fas fa-dumbbell" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                            Fitness Center
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if hotel.has_restaurant %}
                    <div class="col-md-4 mb-3">
                        <p style="color: #555;">
                            <i class="fas fa-utensils" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                            Restaurant
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if hotel.has_spa %}
                    <div class="col-md-4 mb-3">
                        <p style="color: #555;">
                            <i class="fas fa-spa" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                            Spa & Wellness
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if hotel.has_ac %}
                    <div class="col-md-4 mb-3">
                        <p style="color: #555;">
                            <i class="fas fa-snowflake" style="color: #FF6B35; margin-right: 0.5rem;"></i>
                            Air Conditioning
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- ================================================================= -->
            <!-- CHECK-IN / CHECK-OUT TIMES -->
            <!-- ================================================================= -->
            <div style="background-color: #f9f9f9; padding: 1.5rem; border-radius: 8px; margin-bottom: 3rem;">
                <h5 style="color: #222; margin-bottom: 1rem;">Check-in & Check-out Times</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <p style="color: #555;">
                            <strong>Check-in:</strong> {{ hotel.checkin_time|time:"H:i" }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p style="color: #555;">
                            <strong>Check-out:</strong> {{ hotel.checkout_time|time:"H:i" }}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- ================================================================= -->
            <!-- CONTACT SECTION -->
            <!-- ================================================================= -->
            <div style="background-color: #f9f9f9; padding: 1.5rem; border-radius: 8px;">
                <h5 style="color: #222; margin-bottom: 1rem;">Contact Information</h5>
                
                {% if hotel.contact_phone %}
                <p style="color: #555; margin-bottom: 0.5rem;">
                    <i class="fas fa-phone"></i> <strong>Phone:</strong> {{ hotel.contact_phone }}
                </p>
                {% endif %}
                
                {% if hotel.contact_email %}
                <p style="color: #555; margin-bottom: 0.5rem;">
                    <i class="fas fa-envelope"></i> <strong>Email:</strong> {{ hotel.contact_email }}
                </p>
                {% endif %}
            </div>
        </div>
        
        <!-- Sticky Booking Widget (Visible on Mobile) -->
        <div class="col-md-4 d-md-none" style="position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 1rem; border-top: 1px solid #ddd; z-index: 999;">
            <!-- Pricing Widget -->
            {% include "hotels/includes/pricing-calculator.html" %}
        </div>
    </div>
</div>

<!-- ============================================================================ -->
<!-- STYLES -->
<!-- ============================================================================ -->
<style>
    @media (max-width: 768px) {
        .pricing-breakdown {
            position: fixed;
            bottom: 60px;
            left: 0;
            right: 0;
            background: white;
            z-index: 998;
            border-radius: 0;
        }
    }
</style>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/booking_state.js' %}"></script>
<script>
// Ensure book button reflects state and pricing warning hides when ready
function updatePricingVisibility() {
  var warning = document.getElementById('pricing-warning');
  if (!warning) return;
  var ci = document.getElementById('check_in');
  var co = document.getElementById('check_out');
  var room = document.getElementById('room_type_id');
  var meal = document.getElementById('meal_plan_id');
  var datesOk = !!(ci && co && ci.value && co.value && co.value > ci.value);
  var roomOk = !!(room && room.value);
  // If meal select exists and is visible, require a value; otherwise treat as OK (defaults apply)
  var mealGroup = document.getElementById('meal-plan-group');
  var mealVisible = !!(mealGroup && mealGroup.style && mealGroup.style.display !== 'none');
  var mealOk = !mealVisible || (meal && meal.value);
  if (datesOk && roomOk && mealOk) {
    warning.style.display = 'none';
  } else {
    warning.style.display = 'block';
  }
}

document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('book-btn');
    var ci = document.getElementById('check_in');
    var co = document.getElementById('check_out');
    var room = document.getElementById('room_type_id');
    var meal = document.getElementById('meal_plan_id');
    function compute(){
        var state = (window.getBookingState || function(c){
            if (!c.checkIn || !c.checkOut) return 'INITIAL';
            if (c.checkOut <= c.checkIn) return 'INITIAL';
            if (!c.room) return 'DATES_SELECTED';
            return 'READY';
        })({checkIn: ci?.value, checkOut: co?.value, room: room?.value});
        if (btn) btn.disabled = state !== 'READY';
        updatePricingVisibility();
    }
    compute();
    ['change','input'].forEach(function(ev){
        ci?.addEventListener(ev, compute);
        co?.addEventListener(ev, compute);
        room?.addEventListener(ev, compute);
        meal?.addEventListener(ev, compute);
    });
});

// Simple modal to show categorized photo gallery
document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('viewAllPhotosBtn');
    if (!btn) return;
    btn.addEventListener('click', function(){
        var modal = document.getElementById('photoGalleryModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'photoGalleryModal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '1050';
            modal.innerHTML = '<div style="background:#fff; margin:5% auto; padding:1rem; width:90%; max-width:960px; border-radius:8px;">'
                + '<div class="d-flex justify-content-between align-items-center mb-2"><h5 class="m-0">Photo Gallery</h5><button class="btn btn-sm btn-outline-secondary" id="closeGalleryBtn">Close</button></div>'
                + '<div class="mb-2"><span class="badge bg-secondary">Property Photos</span></div>'
                + '<div class="row g-2">'
                + '{% for img in hotel.images.all %}'
                + '<div class="col-3"><img src="{{ img.get_url_with_cache_busting }}" alt="{{ img.caption|default:hotel.name }}" style="width:100%; height:120px; object-fit:cover;"></div>'
                + '{% endfor %}'
                + '</div>'
                + '<div class="mt-3 mb-2"><span class="badge bg-secondary">Room Photos</span></div>'
                + '<div class="row g-2">'
                + '{% for rt in hotel.room_types.all %}{% for rimg in rt.images.all %}'
                + '<div class="col-3"><img src="{{ rimg.image_url_with_cache_busting }}" alt="{{ rt.name }}" style="width:100%; height:120px; object-fit:cover;"></div>'
                + '{% endfor %}{% endfor %}'
                + '</div>'
                + '</div>';
            document.body.appendChild(modal);
            document.getElementById('closeGalleryBtn')?.addEventListener('click', function(){
                modal.remove();
            });
            modal.addEventListener('click', function(e){ if (e.target === modal) modal.remove(); });
        }
    });
});
</script>
{% endblock %}
