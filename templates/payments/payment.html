{% extends 'base.html' %}
{% load static %}

{% block title %}Payment - {{ booking.booking_id }}{% endblock %}

{% block extra_css %}
<style>
    /* ===== HORIZONTAL LAYOUT: Single-screen payment (no vertical scroll) ===== */
    .payment-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 15px;
    }

    .payment-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: start;
    }

    @media (max-width: 992px) {
        .payment-grid {
            grid-template-columns: 1fr;
        }
    }

    .payment-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        background: white;
    }

    .payment-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center;
    }

    .payment-amount {
        font-size: 2rem;
        font-weight: 700;
        color: white;
    }

    .booking-details {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1.5rem;
    }

    .booking-details h5 {
        font-weight: 700;
        margin-bottom: 1rem;
        color: #333;
    }

    .detail-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .price-breakdown {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
    }

    .price-total {
        display: flex;
        justify-content: space-between;
        font-size: 1.2rem;
        font-weight: 700;
        color: #667eea;
        border-top: 2px solid #ddd;
        padding-top: 1rem;
        margin-top: 0.75rem;
    }

    .payment-methods {
        margin-bottom: 1.5rem;
    }

    .payment-method-option {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .payment-method-option:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .payment-method-option.active {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .payment-method-option input[type="radio"] {
        margin-right: 0.5rem;
    }

    .razorpay-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px;
        width: 100%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .razorpay-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .razorpay-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .security-badge {
        text-align: center;
        margin-top: 1rem;
        color: #666;
        font-size: 0.9rem;
    }

    .security-badge i {
        color: #28a745;
        font-size: 1.2rem;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        display: none;
    }

    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        display: none;
    }

    .wallet-checkbox-section {
        margin-top: 1rem;
        padding: 1rem;
        background: #f0f8ff;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container payment-container">
    <!-- Header -->
    <div class="payment-header">
        <h2>Secure Payment</h2>
        <div class="payment-amount">‚Çπ{{ gateway_payable|default:total_payable|floatformat:"2" }}</div>
        <p class="mb-0">Complete your booking</p>
        {% if booking.status == 'reserved' and booking.reservation_seconds_left %}
        <div class="mt-2" style="font-size: 0.9rem;">
            <i class="fas fa-clock"></i> 
            <strong>Time remaining: <span id="payment-countdown" data-seconds="{{ booking.reservation_seconds_left }}"></span></strong>
        </div>
        {% endif %}
    </div>

    <!-- Error/Success Messages -->
    <div id="errorMessage" class="error-message"></div>
    <div id="successMessage" class="success-message"></div>

    <!-- HORIZONTAL LAYOUT: Booking Summary (left) + Payment Options (right) -->
    <div class="payment-grid">
        <!-- LEFT: Booking Summary + Pricing -->
        <div class="payment-card">
            <h5 class="mb-3">Booking Summary</h5>
            <div class="booking-details">
                {% if hotel_booking %}
                    {% if room_type %}
                        <div class="detail-item">
                            <strong>Room Type:</strong> {{ room_type.name }}
                        </div>
                        <div class="detail-item">
                            <strong>Check-in:</strong> {{ hotel_booking.check_in|date:"d M Y" }}
                        </div>
                        <div class="detail-item">
                            <strong>Check-out:</strong> {{ hotel_booking.check_out|date:"d M Y" }}
                        </div>
                        <div class="detail-item">
                            <strong>Number of Rooms:</strong> {{ hotel_booking.number_of_rooms }}
                        </div>
                        <div class="detail-item">
                            <strong>Nights:</strong> {{ hotel_booking.total_nights }}
                        </div>
                        {% if meal_plan %}
                            <div class="detail-item" style="border-top: 1px solid #ddd; padding-top: 0.75rem; margin-top: 0.5rem;">
                                <strong style="color: #667eea;">üçΩÔ∏è Meal Plan:</strong>
                                <p class="mb-0"><strong>{{ meal_plan.name }}</strong></p>
                                <p class="text-muted small mb-0">{{ meal_plan.description }}</p>
                                <p class="text-muted small">‚Çπ{{ meal_plan.price_per_night }}/night</p>
                            </div>
                        {% endif %}
                    {% endif %}
                {% elif booking.booking_type == 'hotel' %}
                    <div class="detail-item">
                        <strong>Type:</strong> Hotel Booking
                    </div>
                {% endif %}
                <div class="detail-item" style="border-top: 1px solid #ddd; padding-top: 0.75rem; margin-top: 0.5rem;">
                    <strong>Booking ID:</strong> <small>{{ booking.booking_id|truncatechars:20 }}</small>
                </div>
                <div class="detail-item">
                    <strong>Date:</strong> {{ booking.created_at|date:"d M Y, H:i" }}
                </div>
            </div>

            <!-- Price Breakdown -->
            <h5 class="mb-3 mt-4">Price Breakdown</h5>
            <div class="price-breakdown">
                <div class="price-row">
                    <span>Base Amount:</span>
                    <span>‚Çπ{{ base_amount|floatformat:"2" }}</span>
                </div>
                {% if promo_discount > 0 %}
                    <div class="price-row text-success">
                        <span>Promo Discount:</span>
                        <span>-‚Çπ{{ promo_discount|floatformat:"2" }}</span>
                    </div>
                    <div class="price-row">
                        <span>Subtotal:</span>
                        <span>‚Çπ{{ subtotal_after_promo|floatformat:"2" }}</span>
                    </div>
                {% endif %}
                <div class="price-row">
                    <span>GST (18%):</span>
                    <span>‚Çπ{{ gst_amount|floatformat:"2" }}</span>
                </div>
                <div class="price-total">
                    <span>Total Payable:</span>
                    <span id="total-payable-amount">‚Çπ{{ total_payable|floatformat:"2" }}</span>
                </div>
            </div>
        </div>

        <!-- RIGHT: Payment Methods + Wallet + Button -->
        <div class="payment-card">
            <h5 class="mb-3">Payment Options</h5>
            
            <!-- Wallet Checkbox -->
            {% if wallet_balance > 0 %}
            <div class="wallet-checkbox-section">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="useWalletCheck" {% if use_wallet %}checked{% endif %} onchange="toggleWalletApplication()">
                    <label class="form-check-label" for="useWalletCheck">
                        <strong>Use Wallet Balance: ‚Çπ{{ wallet_balance|floatformat:"2" }}</strong>
                    </label>
                </div>
                <div id="wallet-breakdown" style="margin-top: 0.75rem; {% if not use_wallet %}display:none;{% endif %}">
                    <div class="price-row" style="background: #e8f5e9; padding: 8px; border-radius: 4px;">
                        <span>Wallet Applied:</span>
                        <span style="color: green;" id="wallet-applied-amount">-‚Çπ{{ wallet_applied|floatformat:"2" }}</span>
                    </div>
                    <div class="price-row" style="background: #fff3e0; padding: 8px; border-radius: 4px; margin-top: 5px;">
                        <span><strong>Gateway Payable:</strong></span>
                        <span><strong id="gateway-payable-amount">‚Çπ{{ gateway_payable|floatformat:"2" }}</strong></span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Payment Methods -->
            <div class="payment-methods">
                <label class="payment-method-option active">
                    <input type="radio" name="payment_method" value="razorpay" id="razorpayRadio" checked>
                    <strong>Razorpay (Credit/Debit/UPI/Cards)</strong>
                    <p class="small text-muted mb-0">Pay via Credit/Debit Card, UPI, Net Banking</p>
                </label>
                <label class="payment-method-option">
                    <input type="radio" name="payment_method" value="upi" id="upiRadio">
                    <strong>UPI (Cashfree)</strong>
                    <p class="small text-muted mb-0">Fast UPI payment or scan QR code</p>
                </label>
                <label class="payment-method-option">
                    <input type="radio" name="payment_method" value="netbanking">
                    <strong>Net Banking</strong>
                    <p class="small text-muted mb-0">Direct bank transfer</p>
                </label>
            </div>

            <!-- Payment Button -->
            {% if gateway_payable > 0 %}
            <!-- Gateway payment required (wallet partial or no wallet) -->
            <button id="paymentBtn" class="razorpay-button" onclick="initiatePayment()">
                <i class="fas fa-lock"></i> <span id="payment-button-text">Pay ‚Çπ{{ gateway_payable|floatformat:"2" }} via Gateway</span>
            </button>
            {% else %}
            <!-- Wallet-only (100% covered by wallet balance) -->
            <button id="paymentBtn" class="razorpay-button" onclick="confirmWalletOnlyBooking()">
                <i class="fas fa-wallet"></i> <span id="payment-button-text">Confirm (‚Çπ{{ total_payable|floatformat:"2" }} from Wallet)</span>
            </button>
            <p class="small text-success mt-2 mb-0">
                <i class="fas fa-check-circle"></i> No gateway payment needed. Your wallet covers the full amount.
            </p>
            {% endif %}

            <!-- Security Badge -->
            <div class="security-badge">
                <i class="fas fa-shield-alt"></i>
                <p class="mb-0"><strong>100% Secure Payment</strong></p>
                <p class="small mb-0">Your payment information is encrypted</p>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-3">
        <a href="{% url 'bookings:booking-confirm' booking.booking_id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</div>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const RAZORPAY_KEY = "{{ razorpay_key }}";
const ORDER_ID = "{{ order_id }}";
const BOOKING_ID = "{{ booking.booking_id }}";
const AMOUNT = parseFloat("{{ total_amount|default:'0' }}") || 0;
const WALLET_BALANCE = parseFloat("{{ wallet_balance|default:'0' }}") || 0;
const AVAILABLE_CASHBACK = parseFloat("{{ available_cashback|default:'0' }}") || 0;
const GATEWAY_PAYABLE = parseFloat("{{ gateway_payable|default:'0' }}") || 0;
const WALLET_APPLIED = parseFloat("{{ wallet_applied|default:'0' }}") || 0;

// Wallet-only booking confirmation (no gateway required)
// Wallet-only booking confirmation (no gateway required)
function confirmWalletOnlyBooking() {
    // Defensive assertion: Verify wallet covers full amount
    if (WALLET_APPLIED === 0) {
        showError('Wallet application error. Please refresh the page.');
        return;
    }
    
    const gatewayPayable = parseFloat("{{ gateway_payable|default:'0' }}") || 0;
    if (gatewayPayable > 0.01) {
        showError(`Gateway payment required: ‚Çπ${gatewayPayable.toFixed(2)}. Please complete payment.`);
        return;
    }
    
    const btn = document.getElementById('paymentBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Confirming from Wallet...';
    
    fetch('{% url "bookings:confirm-wallet-only" booking.booking_id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            wallet_applied: WALLET_APPLIED,
            total_payable: parseFloat("{{ total_payable|default:'0' }}") || 0
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            // Calculate new wallet balance
            const newBalance = WALLET_BALANCE - WALLET_APPLIED;
            
            // Show success with wallet balance update
            showSuccess(`‚úÖ Booking Confirmed!<br>` +
                       `üí∞ Wallet deducted: ‚Çπ${WALLET_APPLIED.toFixed(2)}<br>` +
                       `üí≥ New balance: ‚Çπ${newBalance.toFixed(2)}<br>` +
                       `Redirecting to confirmation...`);
            
            // Immediate redirect (500ms) - no gateway needed
            setTimeout(() => {
                window.location.href = `{% url "bookings:booking-detail" booking.booking_id %}`;
            }, 500);
        } else {
            showError(data.message || 'Booking confirmation failed');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Booking (Wallet-Only)';
        }
    })
    .catch(err => {
        console.error(err);
        showError('Network error. Please try again.');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Booking (Wallet-Only)';
    });
}

function initiatePayment() {
    const selectedRadio = document.querySelector('input[name="payment_method"]:checked');
    
    // CRITICAL: Payment method must be selected
    if (!selectedRadio) {
        showError('‚ö†Ô∏è Please select a payment method before proceeding');
        return;
    }
    
    const paymentMethod = selectedRadio.value;
    
    if (paymentMethod === 'razorpay') {
        initiateRazorpayPayment();
    } else if (paymentMethod === 'wallet') {
        initiateWalletPayment();
    } else {
        showError('Other payment methods coming soon!');
    }
}

function initiateWalletPayment() {
    const totalAvailable = WALLET_BALANCE + AVAILABLE_CASHBACK;
    if (totalAvailable < AMOUNT) {
        showError(`Insufficient wallet balance. Available: ‚Çπ${totalAvailable.toFixed(0)}, Required: ‚Çπ${AMOUNT.toFixed(0)}`);
        return;
    }
    
    // Process wallet payment
    if (confirm(`Pay ‚Çπ${AMOUNT.toFixed(0)} from wallet?`)) {
        fetch('{% url "payments:process-wallet" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                booking_id: BOOKING_ID,
                amount: AMOUNT
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                showSuccess('Payment successful! Redirecting...');
                setTimeout(() => {
                    window.location.href = `{% url "bookings:booking-confirm" booking.booking_id %}`;
                }, 2000);
            } else {
                showError(data.message || 'Wallet payment failed');
            }
        })
        .catch(err => {
            console.error(err);
            showError('Wallet payment error. Please try again.');
        });
    }
}

function initiateRazorpayPayment() {
    const options = {
        key: RAZORPAY_KEY,
        order_id: ORDER_ID,
        amount: Math.round(AMOUNT * 100),
        currency: 'INR',
        name: 'GoExplorer',
        description: `Booking #${BOOKING_ID}`,
        
        handler: async function (response) {
            try {
                // Verify payment
                const verifyResponse = await fetch('{% url "payments:verify" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature
                    })
                });

                const result = await verifyResponse.json();
                
                if (result.status === 'success') {
                    showSuccess('Payment successful! Redirecting...');
                    setTimeout(() => {
                        // Redirect to booking confirmation page (correct URL name)
                        window.location.href = `{% url "bookings:booking-confirm" booking.booking_id %}`;
                    }, 2000);
                } else {
                    showError('Payment verification failed. Please contact support.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Payment verification error. Please contact support.');
            }
        },
        
        theme: {
            color: '#667eea'
        },
        
        modal: {
            ondismiss: function() {
                showError('Payment cancelled. Please try again.');
            }
        }
    };
    
    const rzp = new Razorpay(options);
    rzp.open();
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Update payment button on method change
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', updatePaymentButton);
});

// Wallet toggle function
function toggleWalletApplication() {
    const useWallet = document.getElementById('useWalletCheck').checked;
    const walletBreakdown = document.getElementById('wallet-breakdown');
    
    if (useWallet) {
        walletBreakdown.style.display = 'block';
        window.location.href = '?use_wallet=true';
    } else {
        walletBreakdown.style.display = 'none';
        window.location.href = '?use_wallet=false';
    }
}

function updatePaymentButton() {
    const useWalletCheck = document.getElementById('useWalletCheck');
    const useWallet = useWalletCheck ? useWalletCheck.checked : false;
    const paymentMethodRadio = document.querySelector('input[name="payment_method"]:checked');
    const paymentMethod = paymentMethodRadio ? paymentMethodRadio.value : 'razorpay';
    
    const gatewayAmountEl = document.getElementById('gateway-payable-amount');
    const gatewayAmount = gatewayAmountEl ? parseFloat(gatewayAmountEl.textContent.replace('‚Çπ', '').replace(',', '')) : {{ gateway_payable|default:total_payable }};
    const totalAmount = parseFloat({{ total_payable }});
    
    const btnText = document.getElementById('payment-button-text');
    
    if (useWallet && gatewayAmount <= 0) {
        btnText.innerHTML = `Confirm using Wallet`;
    } else if (useWallet && gatewayAmount > 0) {
        btnText.innerHTML = `Pay ‚Çπ${gatewayAmount.toFixed(2)} via RAZORPAY`;
    } else {
        btnText.innerHTML = `Pay ‚Çπ${totalAmount.toFixed(2)} via RAZORPAY`;
    }
}

// Attach payment button handler with idempotency guard
document.getElementById('paymentBtn').addEventListener('click', function(e) {
    e.preventDefault();
    
    // CRITICAL: Disable button to prevent double submission
    if (this.disabled) {
        showError('Payment processing... please wait');
        return;
    }
    
    this.disabled = true;
    this.textContent = '‚è≥ Processing payment...';
    this.style.opacity = '0.6';
    this.style.cursor = 'not-allowed';
    
    // Call payment handler
    initiatePayment();
    
    // Re-enable after timeout (in case of error)
    setTimeout(() => {
        this.disabled = false;
        this.style.opacity = '1';
        this.style.cursor = 'pointer';
    }, 5000);
});

// Countdown timer for payment page
(function() {
    const countdownEl = document.getElementById('payment-countdown');
    if (!countdownEl) return;

    let remaining = parseInt(countdownEl.dataset.seconds || '0', 10);
    const paymentBtn = document.getElementById('paymentBtn');

    function renderCountdown() {
        if (remaining <= 0) {
            countdownEl.textContent = 'Expired';
            countdownEl.style.color = '#dc3545';
            if (paymentBtn) {
                paymentBtn.disabled = true;
                paymentBtn.textContent = 'Reservation Expired';
            }
            showError('Reservation time expired. Please start a new booking.');
            clearInterval(timerId);
            // Redirect after 3 seconds
            setTimeout(() => {
                window.location.href = '/';
            }, 3000);
            return;
        }
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        countdownEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        remaining -= 1;
    }

    const timerId = setInterval(renderCountdown, 1000);
    renderCountdown();
})();
</script>
{% endblock %}
